# åŸºäº Performace åˆ†æäº‹ä»¶å¾ªç¯

## ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯?

æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å¾ªç¯ï¼Ÿå¯¹äº JavaScript æ˜¯ä¸€é—¨å•çº¿ç¨‹è¯­è¨€æˆ‘ä»¬æ˜¯è‚¯å®šçš„ï¼ŒJavaScript å•çº¿ç¨‹çš„ç‰¹æ€§ä¿è¯äº†æ¸²æŸ“å’Œ JavaScript çš„æ­£å¸¸è¿è¡Œï¼Œä½†åŒæ—¶ä¹Ÿå­˜åœ¨ä¸€å®šçš„é™åˆ¶ã€‚ç†æƒ³æƒ…å†µä¸‹æˆ‘ä»¬å¸Œæœ›æ‰€æœ‰ä»»åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå‡è®¾ä¸²è¡Œä¸­å­˜åœ¨ä¸€ä¸ªè€—æ—¶å¾ˆå¤šçš„ä»»åŠ¡æ—¶ï¼Œä¼šé˜»å¡åç»­ä»»åŠ¡çš„è¿è¡Œï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬æ€ä¹ˆå»è§£å†³å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬çš„äº‹ä»¶å¾ªç¯æ¥å¤„ç†äº†ã€‚

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled.png)

## è®©äººæ„å¤–çš„setTimeout

èœé¸Ÿæ•™ç¨‹

> setTimeout() ï¼šåœ¨æŒ‡å®šçš„æ¯«ç§’æ•°åè°ƒç”¨å‡½æ•°æˆ–è®¡ç®—è¡¨è¾¾å¼
> 

```js
console.log(1);
setTimeout(()=>{
	console.log(2);
},0)
for (let i = 0; i < 5000; i++) { 
	let sum = 0;
	sum += i; 
}
console.log(3);
```

çŒœçŒœä¸Šé¢è¿™æ®µä»£ç æ‰§è¡Œç»“æœæ˜¯å¤šå°‘å‘¢ï¼Ÿæ ¹æ® Event Loop æœºåˆ¶æˆ‘ä»¬çŸ¥é“ç­”æ¡ˆæ˜¯1ã€3ã€2ã€‚ä½†æ˜¯é’ˆå¯¹è¿™æ®µä»£ç ä¸­æœ‰ä¸€ä¸ªç–‘é—®ç‚¹ï¼Œ0ms æ˜¯æŒ‡ 0ms åæ‰§è¡Œ callback å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå®šæ—¶å™¨ä»»åŠ¡è¢«ç»´æŠ¤åœ¨å®šæ—¶å™¨çº¿ç¨‹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨æ—¶å¼€å§‹è®¡æ—¶è¿™ä¸ªä»»åŠ¡ï¼Œ0ms åä¼šå°† callback æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœåœ¨äº‹ä»¶é˜Ÿåˆ—ä¸­å­˜åœ¨ long Taskï¼Œå®šæ—¶å™¨çš„ callback å°†ç­‰å¾…æ‰§è¡Œï¼ŒæŸ¥çœ‹Performanceæ‰§è¡Œè¿‡ç¨‹ï¼š

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%201.png)

## å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ä¹‹å‰ Event Loop å›¾ï¼Œåœ¨å›¾ä¸­æè¿°äº†å‡½æ•°è°ƒç”¨æ ˆã€Web Apiã€ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶æ²¡æœ‰æåˆ°å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰å¾®ä»»åŠ¡å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```jsx
function timerCallback2(){ 
    console.log(2);
} 
function timerCallback(){ 
    console.log(1);
    setTimeout(timerCallback2,0);
} 
setTimeout(timerCallback,0);
```

æˆ‘ä»¬å¸Œæœ›é€šè¿‡ setTimeout æŒ‰ç…§é¡ºåºæ‰§è¡Œ callbackï¼Œé€šè¿‡ Performance å‘ç°ï¼Œåœ¨ä¸¤ä¸ªä»»åŠ¡ä¸­é—´æ’å…¥äº†å…¶ä»–ä»»åŠ¡ï¼Œå¦‚æœæ’å…¥ä»»åŠ¡æ˜¯ long taskï¼Œä¼šå½±å“åç»­ä»»åŠ¡çš„æ‰§è¡Œã€‚å®ä»»åŠ¡æ˜¯æµè§ˆå™¨æä¾›ç»™æˆ‘ä»¬çš„Web Apiï¼Œæ—¶é—´é¢—ç²’åº¦è¾ƒå¤§ï¼Œé’ˆå¯¹åƒ DOM ç­‰é«˜å®æ—¶æ€§æ“ä½œæ˜¯ä¸å¤ªç¬¦åˆçš„ã€‚

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%202.png)

 ä¸ºäº†æ»¡è¶³è¿™ç§é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼ŒV8 å¼•æ“åœ¨åˆ›å»ºå…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡æ—¶ä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæˆæ—¶å»æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬æŠŠæ‰§è¡Œå¾®ä»»åŠ¡çš„æ—¶é—´ç‚¹å«æ£€æŸ¥ç‚¹ã€‚äº†è§£äº†å¾®ä»»åŠ¡é˜Ÿåˆ—åï¼Œæˆ‘ä»¬ä¸°å¯Œä¸€ä¸‹ä¹‹å‰çš„ Event Loopã€‚

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%203.png)

```js
console.log(1)
new Promise(function (resolve) {
  console.log(2)
  resolve()
}).then(function () {
  console.log(3)
})
console.log(4)
```

## äº‹ä»¶å¾ªç¯ä¸æ¸²æŸ“

æµè§ˆå™¨æŒ‰ç…§å¸§æ¸²æŸ“æ–¹å¼ä¸€å¸§ä¸€å¸§æ¸²æŸ“ç½‘é¡µï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸€å¸§éƒ½ä¼šç»å†ç®¡é“æ¯ä¸ªéƒ¨åˆ†çš„å¤„ç†ã€‚å½“è„šæœ¬æ‰§è¡Œé˜»å¡æ—¶ä¼šå¯¼è‡´åç»­æ¸²æŸ“æµç•…é˜»å¡ï¼Œé¡µé¢å¡é¡¿ã€‚

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%204.png)

æµè§ˆå™¨ä½•æ—¶æ¸²æŸ“å¯¹äºæˆ‘ä»¬æ¥è¯´å°±æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œæµè§ˆå™¨è‡ªèº«ä¼šå»åˆ¤æ–­å½“å‰æ˜¯å¦éœ€è¦è¿›è¡Œæ¸²æŸ“ï¼Œå› æ­¤æ€§èƒ½ä¼˜åŒ–çš„æ˜¯ç®¡é“å¸§çš„æµæ°´è¿‡ç¨‹ï¼Œæ¯”å¦‚å‡å°‘è„šæœ¬æ‰§è¡Œæ—¶é•¿ï¼Œé¿å…é‡ç»˜ã€é‡æ’ã€‚å¦‚æœä½ å¸Œæœ›åœ¨æ¯è½®äº‹ä»¶å¾ªç¯ä¸­éƒ½èƒ½å˜åŠ¨ï¼Œä½ éœ€è¦å»äº†è§£ä¸€ä¸‹ requestAnimationFrameã€‚

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%205.png)

```js
<div id='con'>this is con</div>
<script>
var con = document.getElementById('con');
con.onclick = function () {
    setTimeout(function setTimeout1() {
       con.textContent = 0;
       Promise.resolve().then(function Promise1 () {
            console.log('Promise1')
      })
    }, 0)
    setTimeout(function setTimeout2() {
       con.textContent = 1;
       Promise.resolve().then(function Promise2 () {
            console.log('Promise2')
       })
    }, 0)
};
</script>
```

å½“ä¸¤ä¸ªå®ä»»åŠ¡è€—æ—¶ä¸è¶³ä¸€å¸§æ—¶ï¼Œä¼šå‘ç”Ÿæ¸²æŸ“åˆå¹¶ç°è±¡ï¼š

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%206.png)

æˆ‘ä»¬ä¿®æ”¹ä¸Šè¯‰ä»£ç å¦‚ä¸‹ï¼Œå»¶é•¿ç¬¬äºŒä¸ªå®ä»»åŠ¡æ‰§è¡Œæ—¶æœºï¼š

```js
<div id='con'>this is con</div> 
<script> 
  var con = document.getElementById('con'); 
  con.onclick = function () {     
    setTimeout(function setTimeout1() {        
      con.textContent = 0;        
      Promise.resolve().then(function Promise1 () {
        console.log('Promise1')	 
        })     
    }, 0)     
    setTimeout(function setTimeout2() {        
      con.textContent = 1;        
      Promise.resolve().then(function Promise2 () {
        console.log('Promise2') 
      })     
    }, 17) }; 
</script>
```

ä¸¤ä¸ªå®ä»»åŠ¡æ‰§è¡Œæ—¶é—´é—´éš” 17ms ï¼ŒæŒ‰ç…§ä»£ç é€»è¾‘å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å°±è¿›è¡Œæ¸²æŸ“ï¼Œå¹¶æœªå‘ç”Ÿæ¸²æŸ“åˆå¹¶ç°è±¡ã€‚

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%207.png)

## äº‹ä»¶å¾ªç¯ä¹‹ä»»åŠ¡æ‹†åˆ†

ä½œä¸ºæä¾›æ•°æ®ä¸­å°æœåŠ¡çš„å…¬å¸ï¼Œæˆ‘ä»¬ä¸å¯é¿å…ä¼šæ¶‰åŠåˆ°ä¸€äº›å¤æ‚æ•°æ®åˆ°è®¡ç®—ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘ä»¬éœ€è¦è®¡ç®—ä»1åˆ°10 000 000 000æ•°æ®åŠ èµ·æ¥åˆ°åˆï¼Œè®¡ç®—å®Œæ¯•å±•ç¤ºæˆ‘ä»¬åˆ°å¼¹æ¡†ã€‚é€šè¿‡ Performance æˆ‘ä»¬å¯ä»¥çœ‹è§è¿™ä¸ªåŒæ­¥ä»»åŠ¡è€—æ—¶å¿«4sï¼Œæµè§ˆå™¨æ¯å¸§éœ€è¾¾åˆ°60fps/sï¼Œä¹Ÿå°±æ˜¯16.7msæ¯å¸§ï¼Œåœ¨è¿™ä¸ªè®¡ç®—ç»“æŸä¹‹å‰å…¶ä»–ä»»åŠ¡å‡å¾—ä¸åˆ°æ‰§è¡Œï¼Œå¯¼è‡´åç»­æ¸²æŸ“ä»»åŠ¡çš„å»¶è¿Ÿé€ æˆå¡é¡¿ç°è±¡ã€‚

```js
let i = 0;
let start = Date.now();
function count() {
  // long Task
  for (let j = 0; j < 1e9; j++) {
      i++;
  }
  alert("Done in " + (Date.now() - start) + 'ms');
}
count();
```

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%208.png)

æˆ‘ä»¬å¸Œæœ›è¿™ä¸ª long Task æ‹†åˆ†æˆä¸€ä¸ªä¸ªå°çš„ä»»åŠ¡ï¼Œè§£å†³é•¿æ—¶é—´é˜»å¡é€ æˆçš„å¡é¡¿ç°è±¡ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ setTimeout æ‹†åˆ†æˆ‘ä»¬çš„ä»»åŠ¡ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼Œè¿™ä¸ªè®¡ç®—ç¡®å®è¢«æ‹†åˆ†æˆäº†ä¸€ä¸ªä¸ªå°ä»»åŠ¡ã€‚React Firberæ¶æ„ä¸­ä¹Ÿä½¿ç”¨äº†ä»»åŠ¡æ‹†åˆ†è¿™ç§æ€æƒ³å°†é€’å½’æ¸²æŸ“ vdom è½¬ä¸ºäº†é“¾è¡¨å¯ä¸­æ–­æ¸²æŸ“ vdomï¼Œç¬”è€…å¯¹ Fiberäº†è§£å¹¶ä¸å¤šï¼Œè¿™éƒ¨åˆ†å°±ä¸å±•å¼€ç»†è¯´äº†ã€‚

```js
let i = 0;
let start = Date.now();
function count() {
    // long Task
    do{
        i++;
    }while(i % 1e6 != 0)
    if(i == 1e9) {
        alert("Done in " + (Date.now() - start) + 'ms');
    } else {
        setTimeout(count);
    }
}
count();
```

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%209.png)

setTimeout ç¡®å®å°†ä»»åŠ¡è¿›è¡Œäº†æ‹†åˆ†å¤„ç†ï¼Œä½†ä»å ç”¨äº†ä¸»çº¿ç¨‹èµ„æºï¼Œæˆ‘ä»¬çŸ¥é“ä¸»çº¿ç¨‹ä¿è¯äº†é¡µé¢çš„æ¸²æŸ“ã€è„šæœ¬äº¤äº’ã€å¸ƒå±€ç­‰æ“ä½œï¼Œä¸Šè¯‰è¿™ç§å•çº¯çš„æ•°æ®è®¡ç®—æ”¾åœ¨ä¸»çº¿ç¨‹å¤„ç†æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†è€—æ—¶è®¡ç®—æ”¾åœ¨ Web Worker ä¸­å¤„ç†ã€‚  

## äº‹ä»¶å¾ªç¯ä¼˜åŒ–ä¹‹Web Worker

- ä»€ä¹ˆæ˜¯ Web Worker?

<aside>
ğŸ’¡ å½“åœ¨ HTML é¡µé¢ä¸­æ‰§è¡Œè„šæœ¬æ—¶ï¼Œé¡µé¢çš„çŠ¶æ€æ˜¯ä¸å¯å“åº”çš„ï¼Œç›´åˆ°è„šæœ¬å·²å®Œæˆã€‚web worker æ˜¯è¿è¡Œåœ¨åå°çš„ JavaScriptï¼Œç‹¬ç«‹äºå…¶ä»–è„šæœ¬ï¼Œä¸ä¼šå½±å“é¡µé¢çš„æ€§èƒ½ã€‚æ‚¨å¯ä»¥ç»§ç»­åšä»»ä½•æ„¿æ„åšçš„äº‹æƒ…ï¼šç‚¹å‡»ã€é€‰å–å†…å®¹ç­‰ç­‰ï¼Œè€Œæ­¤æ—¶ web worker åœ¨åå°è¿è¡Œã€‚

</aside>

- Web Worker å·¥ä½œåŸç†
    
    ![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%2010.png)
    
- Web Worker æ”¹å˜äº† JavaScript å•çº¿ç¨‹æ‰§è¡Œè¿™ä¸€æœ¬è´¨äº†å—ï¼Ÿ

å¹¶æ²¡æœ‰æ”¹å˜ JavaScript æ˜¯å•çº¿ç¨‹æ‰§è¡Œè¿™ä¸€æœ¬è´¨ã€‚JavaScript æ˜¯ä¸€é—¨æ²¡æœ‰å®šä¹‰çº¿ç¨‹æ¨¡å‹çš„åŸå‹ï¼ŒWeb Worker å¹¶ä¸æ˜¯ JavaScript çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ Web Worker æ—¶ä¸èƒ½æ“ä½œ DOMï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ Web Worker è¿›è¡Œ UI æ›´æ–°è¿™ç§æ“ä½œï¼Œä½†å¦‚æœæŠŠ Web Worker ç†è§£æˆä¸€ä¸ªè®¡ç®—å™¨ï¼Œå¤„ç†ç¹é‡çš„è®¡ç®—ä»»åŠ¡ï¼Œä¼šè®©æˆ‘ä»¬çš„ä¸»çº¿ç¨‹æ‰§è¡Œæ›´åŠ æµç•…ã€‚

```jsx
// worker.js 
self.onmessage = (e=>{
    const { startNum } = e.data;
    let sum = startNum;
    (function count() {
        // long Task
        for (let j = 0; j < 1e9; j++) {
            sum++;
        }
    })();
    self.postMessage(sum);
})

// test.html 
let start = Date.now();
let worker = new Worker('worker.js');
worker.postMessage({startNum: 0});
worker.onmessage = (e) => {
  alert("Done in " + (Date.now() - start) + 'ms');
}
```

![Untitled](%E5%9F%BA%E4%BA%8E%20Performace%20%E5%88%86%E6%9E%90%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%20a380f057b99b4fdbbf568f7246c9328d/Untitled%2011.png)

## æ€»ç»“

ç¬”è€…æœ€åˆå­¦ä¹ äº‹ä»¶å¾ªç¯æ—¶åªä¼šåˆ¤æ–­ä¸€æ®µç®€å•ä»£ç ç‰‡æ®µçš„è¾“å‡ºç»“æœï¼ŒæŸ¥é˜…ç½‘ä¸Šèµ„æ–™å‘ç°å¤§éƒ¨åˆ†èµ„æ–™ä¹Ÿæ˜¯è¿™æ ·ä»‹ç»äº‹ä»¶å¾ªç¯çš„ï¼Œè¿™å¯¼è‡´ç¬”è€…æ€ç»´é•¿æ—¶é—´èšç„¦åœ¨ä¸€æ®µè„šæœ¬çš„è¾“å‡ºç»“æœï¼Œæ¥è§¦ Web Worker æ—¶é’ˆå¯¹å¤æ‚è®¡ç®—å¼€ä¸€ä¸ªçº¿ç¨‹çš„å¿…è¦æ€§ä¹ŸæŒæœ‰æ€€ç–‘ã€‚é€šè¿‡è¿™æ®µæ—¶é—´çš„å­¦ä¹ ï¼Œè®©æˆ‘ç†è§£åˆ°äº‹ä»¶å¾ªç¯çš„æœ¬è´¨æ˜¯ä¿è¯ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€UI æ¸²æŸ“æœ‰åºè¿›è¡Œçš„åŸºçŸ³ï¼Œè„šæœ¬é•¿æ—¶é—´çš„æ‰§è¡Œä¼šå¯¼è‡´åç»­ä»»åŠ¡é˜»å¡ï¼Œé¡µé¢å‘ˆç°å¡é¡¿ç°è±¡ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Web Worker é‡‡ç”¨å¼€ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤æ‚è®¡ç®—çš„åŸå› ã€‚